# ============================================================================
# JUEZ SEGURO - Infraestructura de Bases de Datos
# Sistema Judicial Electrónico con Common Criteria
# ============================================================================
# Este archivo configura CUATRO nodos PostgreSQL aislados en una red interna
# para cumplir con los requisitos de protección de flujo de información.
# - db_usuarios: FIA (Identificación y Autenticación)
# - db_casos:    FDP (Protección de Datos)
# - db_logs:     FAU (Auditoría)
# - db_secrets:  FCS (Soporte Criptográfico) - NUEVO
# ============================================================================

services:
  # ----------------------------------------------------------------
  # 1. BDD USUARIOS Y ATRIBUTOS (FIA - Identidad y Acceso)
  # Contiene: Credenciales, Roles, Atributos de Seguridad.
  # Propósito: Gestión centralizada de autenticación y autorización
  # ----------------------------------------------------------------
  db_usuarios:
    image: postgres:15-alpine
    container_name: juez_seguro_db_users
    restart: always
    environment:
      POSTGRES_DB: db_usuarios
      POSTGRES_USER: admin_users
      POSTGRES_PASSWORD: ${DB_PASS_USERS}
      # Configuración de seguridad PostgreSQL (md5 para desarrollo)
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - ./scripts/usuarios:/docker-entrypoint-initdb.d:ro
      - pg_data_users:/var/lib/postgresql/data
    networks:
      - backend_secure_net
    # DESARROLLO: Descomentar para acceder desde host
    # ports:
    #   - "5435:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin_users -d db_usuarios"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ----------------------------------------------------------------
  # 2. BDD CASOS Y PSEUDÓNIMOS (FDP - Operación Anonimizada)
  # Contiene: Expedientes, Mapeo de IDs Anónimos, Documentos.
  # Propósito: Almacenamiento seguro de causas judiciales con
  #            pseudonimización para protección de datos sensibles
  # ----------------------------------------------------------------
  db_casos:
    image: postgres:15-alpine
    container_name: juez_seguro_db_cases
    restart: always
    environment:
      POSTGRES_DB: db_casos
      POSTGRES_USER: admin_cases
      POSTGRES_PASSWORD: ${DB_PASS_CASES}
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - ./scripts/casos:/docker-entrypoint-initdb.d:ro
      - pg_data_cases:/var/lib/postgresql/data
    networks:
      - backend_secure_net
    # DESARROLLO: Descomentar para acceder desde host
    # ports:
    #   - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin_cases -d db_casos"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ----------------------------------------------------------------
  # 3. BDD LOGS DE AUDITORÍA (FAU - Trazabilidad Inmutable)
  # Contiene: Registros de eventos, hashes de integridad.
  # Propósito: Registro inmutable de todas las acciones del sistema
  #            para cumplir con requisitos de auditoría Common Criteria
  # ----------------------------------------------------------------
  db_logs:
    image: postgres:15-alpine
    container_name: juez_seguro_db_logs
    restart: always
    environment:
      POSTGRES_DB: db_logs
      POSTGRES_USER: admin_logs
      POSTGRES_PASSWORD: ${DB_PASS_LOGS}
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - ./scripts/logs:/docker-entrypoint-initdb.d:ro
      - pg_data_logs:/var/lib/postgresql/data
    networks:
      - backend_secure_net
    # DESARROLLO: Descomentar para acceder desde host
    # ports:
    #   - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin_logs -d db_logs"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ----------------------------------------------------------------
  # 4. BDD SECRETOS CRIPTOGRÁFICOS (FCS - Cryptographic Support)
  # Contiene: Secretos encriptados con AES-256-GCM
  # Propósito: Almacenamiento seguro de claves y secretos del sistema
  #            La MASTER_KEY nunca se almacena, solo en memoria
  # ----------------------------------------------------------------
  db_secrets:
    image: postgres:15-alpine
    container_name: juez_seguro_db_secrets
    restart: always
    environment:
      POSTGRES_DB: db_secrets
      POSTGRES_USER: admin_secrets
      POSTGRES_PASSWORD: ${DB_PASS_SECRETS}
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - ./scripts/secrets:/docker-entrypoint-initdb.d:ro
      - pg_data_secrets:/var/lib/postgresql/data
    networks:
      - backend_secure_net
    # DESARROLLO: Descomentar para acceder desde host
    # ports:
    #   - "5436:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin_secrets -d db_secrets"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ----------------------------------------------------------------
  # 5. BACKEND API - Servidor de Aplicación Node.js/TypeScript
  # Maneja la lógica de negocio y el almacenamiento seguro de documentos
  # Sprint 3: Integración PKI para firma electrónica
  # Sprint 4: Secretos desde BD (db_secrets)
  # ----------------------------------------------------------------
  backend_api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: juez_seguro_backend_api
    restart: always
    ports:
      - "3000:3000"
    environment:
      # NODE_ENV: development para desarrollo, production para producción
      NODE_ENV: ${NODE_ENV:-production}
      # Conexiones a las bases de datos
      DB_USERS_HOST: db_usuarios
      DB_USERS_PORT: 5432
      DB_USERS_NAME: db_usuarios
      DB_USERS_USER: admin_users
      DB_USERS_PASSWORD: ${DB_PASS_USERS}
      
      DB_CASES_HOST: db_casos
      DB_CASES_PORT: 5432
      DB_CASES_NAME: db_casos
      DB_CASES_USER: admin_cases
      DB_CASES_PASSWORD: ${DB_PASS_CASES}
      
      DB_LOGS_HOST: db_logs
      DB_LOGS_PORT: 5432
      DB_LOGS_NAME: db_logs
      DB_LOGS_USER: admin_logs
      DB_LOGS_PASSWORD: ${DB_PASS_LOGS}
      
      # ============================================================
      # Base de Datos de Secretos (FCS - Cryptographic Support)
      # ============================================================
      DB_SECRETS_HOST: db_secrets
      DB_SECRETS_PORT: 5432
      DB_SECRETS_NAME: db_secrets
      DB_SECRETS_USER: admin_secrets
      DB_SECRETS_PASSWORD: ${DB_PASS_SECRETS}
      
      # Clave maestra para desencriptar secretos (ÚNICO secreto en ENV)
      # Se usa PBKDF2 para derivar la clave AES-256
      MASTER_KEY_PASSWORD: ${MASTER_KEY_PASSWORD}
      
      # Configuración JWT (ahora cargado desde db_secrets)
      JWT_EXPIRATION: ${JWT_EXPIRATION:-8h}
      
      # CORS - Orígenes permitidos (separados por comas)
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:8080,http://localhost:5173}
      
      # Ruta de almacenamiento seguro para documentos
      SECURE_STORAGE_PATH: /app/storage/expedientes_seguros
      
      # ============================================================
      # Sprint 3: Configuración PKI para Firma Electrónica
      # ============================================================
      # Rutas de certificados (montados como solo lectura)
      PKI_CA_CERT_PATH: /app/certs/ca/ca.crt
      PKI_JUECES_CERTS_PATH: /app/certs/jueces
      
      # Password para archivos PFX (cargado desde db_secrets)
      # PFX_PASSWORD: ahora en db_secrets
      
      # Ruta de almacenamiento WORM para decisiones firmadas
      DECISIONES_FIRMADAS_PATH: /app/storage/decisiones_firmadas
      
    volumes:
      # Almacenamiento de expedientes (existente)
      - secure_docs_storage:/app/storage/expedientes_seguros
      
      # Sprint 3: Infraestructura PKI (Solo lectura) - Solo certificados públicos
      - ./certs/ca:/app/certs/ca:ro
      - ./certs/jueces:/app/certs/jueces:ro
      
      # Sprint 3: Almacenamiento WORM para decisiones firmadas
      - secure_decisions_storage:/app/storage/decisiones_firmadas
      
    networks:
      - backend_secure_net
    depends_on:
      db_usuarios:
        condition: service_healthy
      db_casos:
        condition: service_healthy
      db_logs:
        condition: service_healthy
      db_secrets:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ----------------------------------------------------------------
  # ⚠️ ADMINER REMOVIDO PARA PRODUCCIÓN
  # ----------------------------------------------------------------
  # Adminer fue eliminado por seguridad (CWE-200: Exposure of Sensitive Information)
  # Un panel de administración de BD expuesto permite:
  # - Acceso no autorizado a datos sensibles
  # - Modificación/eliminación de registros
  # - Extracción masiva de información (data exfiltration)
  #
  # Para desarrollo local, usar herramientas como:
  # - pgAdmin (instalación local)
  # - DBeaver (instalación local)
  # - psql CLI dentro del contenedor
  #
  # Ejemplo de acceso seguro a BD en desarrollo:
  #   docker exec -it juez_seguro_db_users psql -U admin_users -d db_usuarios
  # ----------------------------------------------------------------

# ============================================================================
# REDES - Aislamiento de Tráfico
# ============================================================================
networks:
  backend_secure_net:
    driver: bridge
    # PRODUCCIÓN: La red está aislada por defecto (internal: true)
    # DESARROLLO: Comentar 'internal: true' si necesitas acceso a internet desde contenedores
    # NOTA: Comentado para permitir acceso al backend desde el host
    # internal: true
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================================
# VOLÚMENES - Persistencia de Datos
# ============================================================================
volumes:
  pg_data_users:
    name: juez_seguro_users_data
  pg_data_cases:
    name: juez_seguro_cases_data
  pg_data_logs:
    name: juez_seguro_logs_data
  pg_data_secrets:
    name: juez_seguro_secrets_data
    # Volumen para secretos encriptados (FCS)
    # Los datos están encriptados con AES-256-GCM
  secure_docs_storage:
    name: juez_seguro_secure_docs
    # Volumen persistente para almacenamiento WORM (Write Once Read Many)
    # Contiene PDFs y documentos del expediente electrónico
    # La integridad se garantiza mediante hashes en db_casos
  
  # Sprint 3: Volumen WORM para decisiones judiciales firmadas
  secure_decisions_storage:
    name: juez_seguro_decisions_firmadas
    # Almacenamiento inmutable para autos, providencias y sentencias firmadas
    # Los documentos aquí almacenados no pueden ser modificados ni eliminados
    # Integridad verificada mediante hash SHA-256 en tabla decisiones_judiciales
