# ============================================================================
# JUEZ SEGURO - Infraestructura de Bases de Datos
# Sistema Judicial Electrónico con Common Criteria
# ============================================================================
# Este archivo configura tres nodos PostgreSQL aislados en una red interna
# para cumplir con los requisitos de protección de flujo de información.
# ============================================================================

services:
  # ----------------------------------------------------------------
  # 1. BDD USUARIOS Y ATRIBUTOS (FIA - Identidad y Acceso)
  # Contiene: Credenciales, Roles, Atributos de Seguridad.
  # Propósito: Gestión centralizada de autenticación y autorización
  # ----------------------------------------------------------------
  db_usuarios:
    image: postgres:15-alpine
    container_name: juez_seguro_db_users
    restart: always
    environment:
      POSTGRES_DB: db_usuarios
      POSTGRES_USER: admin_users
      POSTGRES_PASSWORD: ${DB_PASS_USERS}
      # Configuración de seguridad PostgreSQL (md5 para desarrollo)
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - ./scripts/usuarios:/docker-entrypoint-initdb.d:ro
      - pg_data_users:/var/lib/postgresql/data
    networks:
      - backend_secure_net
    ports:
      - "5435:5432" # Cambiado de 5432 a 5435 para evitar conflicto con PostgreSQL local
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin_users -d db_usuarios"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ----------------------------------------------------------------
  # 2. BDD CASOS Y PSEUDÓNIMOS (FDP - Operación Anonimizada)
  # Contiene: Expedientes, Mapeo de IDs Anónimos, Documentos.
  # Propósito: Almacenamiento seguro de causas judiciales con
  #            pseudonimización para protección de datos sensibles
  # ----------------------------------------------------------------
  db_casos:
    image: postgres:15-alpine
    container_name: juez_seguro_db_cases
    restart: always
    environment:
      POSTGRES_DB: db_casos
      POSTGRES_USER: admin_cases
      POSTGRES_PASSWORD: ${DB_PASS_CASES}
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - ./scripts/casos:/docker-entrypoint-initdb.d:ro
      - pg_data_cases:/var/lib/postgresql/data
    networks:
      - backend_secure_net
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin_cases -d db_casos"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ----------------------------------------------------------------
  # 3. BDD LOGS DE AUDITORÍA (FAU - Trazabilidad Inmutable)
  # Contiene: Registros de eventos, hashes de integridad.
  # Propósito: Registro inmutable de todas las acciones del sistema
  #            para cumplir con requisitos de auditoría Common Criteria
  # ----------------------------------------------------------------
  db_logs:
    image: postgres:15-alpine
    container_name: juez_seguro_db_logs
    restart: always
    environment:
      POSTGRES_DB: db_logs
      POSTGRES_USER: admin_logs
      POSTGRES_PASSWORD: ${DB_PASS_LOGS}
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - ./scripts/logs:/docker-entrypoint-initdb.d:ro
      - pg_data_logs:/var/lib/postgresql/data
    networks:
      - backend_secure_net
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin_logs -d db_logs"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ----------------------------------------------------------------
  # 4. BACKEND API - Servidor de Aplicación Node.js/TypeScript
  # Maneja la lógica de negocio y el almacenamiento seguro de documentos
  # Sprint 3: Integración PKI para firma electrónica
  # ----------------------------------------------------------------
  backend_api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: juez_seguro_backend_api
    restart: always
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      # Conexiones a las bases de datos
      DB_USERS_HOST: db_usuarios
      DB_USERS_PORT: 5432
      DB_USERS_NAME: db_usuarios
      DB_USERS_USER: admin_users
      DB_USERS_PASSWORD: ${DB_PASS_USERS}
      
      DB_CASES_HOST: db_casos
      DB_CASES_PORT: 5432
      DB_CASES_NAME: db_casos
      DB_CASES_USER: admin_cases
      DB_CASES_PASSWORD: ${DB_PASS_CASES}
      
      DB_LOGS_HOST: db_logs
      DB_LOGS_PORT: 5432
      DB_LOGS_NAME: db_logs
      DB_LOGS_USER: admin_logs
      DB_LOGS_PASSWORD: ${DB_PASS_LOGS}
      
      # Configuración JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-8h}
      
      # Ruta de almacenamiento seguro para documentos
      SECURE_STORAGE_PATH: /app/storage/expedientes_seguros
      
      # ============================================================
      # Sprint 3: Configuración PKI para Firma Electrónica
      # ============================================================
      # Rutas de certificados (montados como solo lectura)
      PKI_CA_CERT_PATH: /app/certs/ca/ca.crt
      PKI_JUECES_CERTS_PATH: /app/certs/jueces
      
      # Password para archivos PFX (En producción usar Docker Secrets o Vault)
      PFX_PASSWORD: ${PFX_PASSWORD:-Seguridad2026}
      
      # Ruta del secreto JWT desde archivo
      JWT_SECRET_FILE: /app/certs/jwt_secret.key
      
      # Ruta de almacenamiento WORM para decisiones firmadas
      DECISIONES_FIRMADAS_PATH: /app/storage/decisiones_firmadas
      
      # Salt para anonimización
      ANONYMIZATION_SALT_FILE: /app/certs/anonymization.salt
      
    volumes:
      # Almacenamiento de expedientes (existente)
      - secure_docs_storage:/app/storage/expedientes_seguros
      
      # Sprint 3: Infraestructura PKI (Solo lectura)
      - ./certs/ca:/app/certs/ca:ro
      - ./certs/jueces:/app/certs/jueces:ro
      - ./certs/jwt_secret.key:/app/certs/jwt_secret.key:ro
      - ./certs/anonymization.salt:/app/certs/anonymization.salt:ro
      
      # Sprint 3: Almacenamiento WORM para decisiones firmadas
      - secure_decisions_storage:/app/storage/decisiones_firmadas
      
    networks:
      - backend_secure_net
    depends_on:
      db_usuarios:
        condition: service_healthy
      db_casos:
        condition: service_healthy
      db_logs:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ----------------------------------------------------------------
  # 5. ADMINER - Panel de Administración (Solo Desarrollo)
  # Interfaz web para gestionar las bases de datos durante desarrollo
  # ----------------------------------------------------------------
  adminer:
    image: adminer:4-standalone
    container_name: juez_seguro_adminer
    restart: unless-stopped
    ports:
      - "8080:8080"
    networks:
      - backend_secure_net
    environment:
      ADMINER_DEFAULT_SERVER: db_usuarios
    profiles:
      - dev # Solo se inicia con: docker-compose --profile dev up
    depends_on:
      - db_usuarios
      - db_casos
      - db_logs

# ============================================================================
# REDES - Aislamiento de Tráfico
# ============================================================================
networks:
  backend_secure_net:
    driver: bridge
    # internal: true # Deshabilitado para desarrollo. Habilitar en producción
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================================
# VOLÚMENES - Persistencia de Datos
# ============================================================================
volumes:
  pg_data_users:
    name: juez_seguro_users_data
  pg_data_cases:
    name: juez_seguro_cases_data
  pg_data_logs:
    name: juez_seguro_logs_data
  secure_docs_storage:
    name: juez_seguro_secure_docs
    # Volumen persistente para almacenamiento WORM (Write Once Read Many)
    # Contiene PDFs y documentos del expediente electrónico
    # La integridad se garantiza mediante hashes en db_casos
  
  # Sprint 3: Volumen WORM para decisiones judiciales firmadas
  secure_decisions_storage:
    name: juez_seguro_decisions_firmadas
    # Almacenamiento inmutable para autos, providencias y sentencias firmadas
    # Los documentos aquí almacenados no pueden ser modificados ni eliminados
    # Integridad verificada mediante hash SHA-256 en tabla decisiones_judiciales
